.. _ctseg:

The CTSEG double expansion algorithm 
====================================

Double expansion
****************

The segment-picture continuous-time quantum Monte Carlo algorithm
(CTSEG), in its double expansion version, is based on an expansion of the partition function in powers of the 
hybridization function :math:`\Delta(\tau)` and perpendicular spin-spin interaction 
:math:`J_{\perp} (\tau)`. Details can be found in [#ctqmc1]_ [#ctqmc2]_. The partition function is :math:`Z = \int [Dc][D\overline{c}]e^{-\mathcal{S}[c,\overline{c}]}`,
with the action :math:`\mathcal{S}` given by 

.. math::

  \begin{split}
  \mathcal{S}  &= \iint_0^{\beta} \mathrm{d} \tau \mathrm{d} \tau' \sum_{a,b} \left\{ \overline{c}_{a\sigma} (\tau)
  \left( (\partial_{\tau} + \mu_{a\sigma})\delta_{ab}^{\sigma \sigma'} \delta_{\tau - \tau'} + \Delta_{ab}^{\sigma \sigma'}(\tau - \tau')\right)
  c_{b\sigma'}(\tau') \right\} \\
  &+ \frac{1}{2} \iint_0^{\beta} \mathrm{d} \tau \mathrm{d} \tau' \sum_{a,b} \mathcal{U}_{ab}(\tau - \tau') n_a(\tau) n_b(\tau') 
  + \frac{1}{2} \iint_0^{\beta} \mathrm{d} \tau \mathrm{d} \tau' \sum_{a, \xi = x, y, z} s_a^{\xi}(\tau) \mathcal{J}_a^{\xi}(\tau - \tau') s_a^{\xi} (\tau')
  \end{split}

Here :math:`\beta` is the inverse temperature, :math:`a` denote orbital indices, :math:`\sigma` spin indices (:math:`\sigma = \uparrow, \downarrow`),
:math:`n_a \equiv \sum_{\sigma} n_{a\sigma}`, :math:`s_a^{\xi} \equiv \frac{1}{2} \sum_{\sigma \sigma'} \overline{c}_{a\sigma}
\sigma_{\sigma \sigma'}^{\xi} c_{a \sigma'}` and :math:`\sigma^{\xi}` are the Pauli matrices. :math:`\overline{c}_{a\sigma}(\tau)`
and :math:`c_{a\sigma}(\tau)` are the :math:`\beta`-antiperiodic Grassmann fields corresponding to the fermion
creation and annihilation operators on the impurity, respectively.

This action can be recast as 

.. math::

  \begin{split}
  \mathcal{S}  &= \iint_0^{\beta} \mathrm{d} \tau \mathrm{d} \tau' \sum_{a,b} \left\{ \overline{c}_{a\sigma} (\tau)
  \left( (\partial_{\tau} + \mu_{a\sigma})\delta_{ab}^{\sigma \sigma'} \delta_{\tau - \tau'} + \Delta_{ab}^{\sigma \sigma'}(\tau - \tau')\right)
  c_{b\sigma'}(\tau') \right\} \\
  &+ \frac{1}{2} \iint_0^{\beta} \mathrm{d} \tau \mathrm{d} \tau' \sum_{u,v} \mathcal{U}_{uv}(\tau - \tau') n_u(\tau) n_v(\tau') 
  + \frac{1}{2} \iint_0^{\beta} \mathrm{d} \tau \mathrm{d} \tau' \sum_{a} \mathcal{J}_a^{\perp}(\tau - \tau') s_a^{+}(\tau) s_a^{-} (\tau')
  \end{split}

where 

.. math::

    \mathcal{U}_{uv}(\tau - \tau')  = \mathcal{U}_{ab}(\tau - \tau') + (-1)^{\sigma \sigma'} \frac{1}{4} \mathcal{J}_a^z(\tau) \delta_{ab},

:math:`s^{\pm} = s_x \pm i s_y` and :math:`\mathcal{J}^{\perp} \equiv \mathcal{J}^x = \mathcal{J}^y`. The CTSEG solver 
stochastically explores the terms (or configurations) generated by the expansion of :math:`\mathcal{S}` in powers of :math:`\Delta(\tau)`
and :math:`\mathcal{J}^{\perp}(\tau)` and samples the observables of interest (e.g. the Green's function) every few 
configurations. 

.. note::

    Our CTSEG implementation supports the :math:`\mathcal{J}^{\perp}(\tau)` expansion only for a single orbital. For multiple 
    orbitals, an expansion only in :math:`\Delta(\tau)` is possible. For a single orbital, it is also possible to carry out an 
    expansion in :math:`\mathcal{J}^{\perp}(\tau)` only (i.e., with :math:`\Delta(\tau) = 0`). 

Configuration
**************

A term of the double expansion takes the general form 

.. math::

  w = \mathrm{det} [\Delta] \prod_{i = 1}^{k} \left[ - \frac{\mathcal{J}_{\perp}(q(\alpha_i) - \beta_i) }{2} \right] w_{\rm loc}, 

where :math:`w_{\rm loc}` is the local trace factor: 

.. math::

  w_{\rm loc} = \langle \psi \vert e^{-S_{\rm loc}} c(v_1)\overline{c}(u_1) \dots c(v_n) \overline{c}(u_n) s^+(\alpha_1)s^-(\beta_1) \dots s^+(\alpha_k) s^-(\beta_k) \vert \psi \rangle.

We have denoted :math:`\vert \Psi \rangle` the basis states of the isolated impurity and :math:`S_{\rm loc}` the corresponding action.
:math:`[\Delta]` is the matrix with elements :math:`[\Delta]_{ij} = \Delta(u_i - v_j)` and :math:`q` is a permutation 
of :math:`(1, \dots, k)`. We chose to regroup all the possible permutations of the "hybridized" operators into a determinant
because it allows for numerically fast updates, while there is no advantage to regrouping the permutations of the spin 
operators into a permanent. 

We will designate by "color" the set of indices carried by an operator in addition to its time (typically, spin and orbital). 
Under the applicability conditions of CTSEG (the interaction commutes with the density operator) the configuration can be
represented as a set of imaginary time segments for each color: within a segment, the color is occupied. Then, the local trace
factor supports a simple expression in terms of the overlaps of those segments between different colors (up to a sign, discussed below):

.. math::

  w_{\rm loc} = w_{\rm st}(\tilde U_{ab}, \tilde \mu_a) \cdot \exp \left[ \sum_{ij} s_i s_j K_{a(i)b(j)} (\tau_i - \tau_j) \right], 

where :math:`s_i = 1` for creation operators and -1 otherwise. We split the interaction into a 
static and a dynamic part: :math:`\mathcal{U}_{ab}(\tau) = U_{ab} + D_{ab}(\tau)`. The dynamical interaction kernel 
:math:`K_{ab}` is defined by :math:`K_{ab}''(\tau) = D_{ab}(\tau)` and :math:`K_{ab}(\tau = 0^+) = K_{ab}(\tau = \beta^-) = 0`. 
The static trace factor is 

.. math::

  w_{\rm st}(U_{ab}, \mu_a) = \exp \left[ -\sum_{a \neq b} U_{ab} O_{ab} + \sum_a \mu_a \ell_a \right].

Here :math:`O_{ab}` is the overlap between the segments of colors :math:`a` and :math:`b`, and :math:`\ell_a` is the occupied length in color a.
In the presence of dynamical interactions, the static trace factor is computed with a renormalized interaction and chemical potential: 
:math:`\tilde U_{ab} = U_{ab} - 2 K'_{ab}(0)` and :math:`\tilde \mu_{a} = \mu_a + K'_{aa}(0)`. 

Sign
*****

The sign of the Monte Carlo weight depends on the initial ordering of the operators in the expansion. The total sign is the product of 
the sign of the determinant and the sign of the trace, and the ordering of the spin operators does not influence the sign. 
The trace is positive if all the hybridized operators (whatever their nature) are ordered by decreasing (from left to right) time and color. 
In practice, we define the matrix :math:`[\Delta]` in such a way that the times corresponding to its rows (creation operators)
and columns (annihilation operators) are both in increasing order, regardless of color: this fixes
the sign of the determinant. We then compute the sign of the 
permutation that takes the sequence :math:`[c c^{\dagger}  \dots c c^{\dagger} ]` with the :math:`c` and
:math:`c^{\dagger}` increasing-time-ordered to the decreasing-time-and-color-ordered sequence of operators. 


.. [#ctqmc1] Otsuki, J. Spin-boson coupling in continuous-time quantum Monte Carlo. 
             Phys. Rev. B 87, 125102 (2013).

.. [#ctqmc2] Ayral, T. PhD thesis: Nonlocal Coulomb Interactions and Electronic
            Correlations: Novel Many-Body Approaches. Ecole Polytechnique (2015). `tel-01247625 <https://hal.archives-ouvertes.fr/tel-01247625>`_
